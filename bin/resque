#!/usr/bin/env ruby

require 'thor'
require 'resque'

class SampleJob
  def self.perform
    2 + 2
  end
end

class Resque
  class CLI < Thor

    desc "work", "Start processing jobs."
    method_option :queue, :default => :default, :aliases => ["-q"]
    def work
      consumer = Thread.new do
        resque = Resque.new(Resque::RedisQueue)
        loop do
          result = resque.process_job
          if result
            puts "PROCESSED JOB. RESULT: #{result}"
          else
            sleep 5
          end
        end
      end
      consumer.join
    end

    desc "test", "Test the queue"
    def test
      producer = Thread.new do
        resque = Resque.new(Resque::RedisQueue)
        5.times do |i|
          resque.enqueue(SampleJob)
        end
      end
      invoke :work
    end
  end
end

Resque::CLI.start
